"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.prepareUpgrade = void 0;
const upgrades_core_1 = require("@openzeppelin/upgrades-core");
const utils_1 = require("./utils");
async function prepareUpgrade(proxyOrBeacon, Contract, opts = {}) {
    const proxyOrBeaconAddress = (0, utils_1.getContractAddress)(proxyOrBeacon);
    const { deployer } = (0, utils_1.withDefaults)(opts);
    const provider = (0, utils_1.wrapProvider)(deployer.provider);
    let deployedImpl;
    if (await (0, upgrades_core_1.isTransparentOrUUPSProxy)(provider, proxyOrBeaconAddress)) {
        deployedImpl = await (0, utils_1.deployProxyImpl)(Contract, opts, proxyOrBeaconAddress);
    }
    else if (await (0, upgrades_core_1.isBeaconProxy)(provider, proxyOrBeaconAddress)) {
        const beaconAddress = await (0, upgrades_core_1.getBeaconAddress)(provider, proxyOrBeaconAddress);
        deployedImpl = await (0, utils_1.deployBeaconImpl)(Contract, opts, beaconAddress);
    }
    else if (await (0, upgrades_core_1.isBeacon)(provider, proxyOrBeaconAddress)) {
        deployedImpl = await (0, utils_1.deployBeaconImpl)(Contract, opts, proxyOrBeaconAddress);
    }
    else {
        throw new upgrades_core_1.PrepareUpgradeUnsupportedError(proxyOrBeaconAddress);
    }
    return deployedImpl.impl;
}
exports.prepareUpgrade = prepareUpgrade;
//# sourceMappingURL=prepare-upgrade.js.map